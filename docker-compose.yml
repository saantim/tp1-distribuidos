name: coffee-shop-analyzer
services:
  rabbitmq:
    hostname: rabbitmq
    container_name: rabbitmq
    image: rabbitmq:4.1.4-management
    volumes:
    - rabbitmq-volume:/var/lib/rabbitmq
    - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      RABBITMQ_NODENAME: rabbit@rabbitmq
    networks:
    - coffee
    ports:
    - 5672:5672
    - 8080:15672
    healthcheck:
      test: rabbitmq-diagnostics -q check_running && rabbitmq-diagnostics -q check_local_alarms && rabbitmq-diagnostics -q check_port_connectivity
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 40s
  gateway:
    container_name: gateway
    build:
      context: .
      dockerfile: ./gateway/Dockerfile
    volumes:
    - ./gateway:/gateway
    - ./shared:/shared
    entrypoint: python main.py
    networks:
    - coffee
    depends_on:
      transformer_menu_items:
        condition: service_healthy
      transformer_stores:
        condition: service_healthy
      transformer_users_0:
        condition: service_healthy
      transformer_users_1:
        condition: service_healthy
      transformer_users_2:
        condition: service_healthy
      transformer_users_3:
        condition: service_healthy
      transformer_users_4:
        condition: service_healthy
      transformer_transactions_0:
        condition: service_healthy
      transformer_transactions_1:
        condition: service_healthy
      transformer_transactions_2:
        condition: service_healthy
      transformer_transactions_3:
        condition: service_healthy
      transformer_transactions_4:
        condition: service_healthy
      transformer_transaction_items_0:
        condition: service_healthy
      transformer_transaction_items_1:
        condition: service_healthy
      transformer_transaction_items_2:
        condition: service_healthy
      transformer_transaction_items_3:
        condition: service_healthy
      transformer_transaction_items_4:
        condition: service_healthy
      q1_filter_year_0:
        condition: service_healthy
      q1_filter_year_1:
        condition: service_healthy
      q1_filter_year_2:
        condition: service_healthy
      q1_filter_year_3:
        condition: service_healthy
      q1_filter_year_4:
        condition: service_healthy
      q1_filter_hour_0:
        condition: service_healthy
      q1_filter_hour_1:
        condition: service_healthy
      q1_filter_hour_2:
        condition: service_healthy
      q1_filter_hour_3:
        condition: service_healthy
      q1_filter_hour_4:
        condition: service_healthy
      q1_filter_amount_0:
        condition: service_healthy
      q1_filter_amount_1:
        condition: service_healthy
      q1_filter_amount_2:
        condition: service_healthy
      q1_filter_amount_3:
        condition: service_healthy
      q1_filter_amount_4:
        condition: service_healthy
      q1_sink:
        condition: service_healthy
      q2_filter_items_0:
        condition: service_healthy
      q2_filter_items_1:
        condition: service_healthy
      q2_filter_items_2:
        condition: service_healthy
      q2_filter_items_3:
        condition: service_healthy
      q2_filter_items_4:
        condition: service_healthy
      q2_aggregate_period_0:
        condition: service_healthy
      q2_aggregate_period_1:
        condition: service_healthy
      q2_aggregate_period_2:
        condition: service_healthy
      q2_aggregate_period_3:
        condition: service_healthy
      q2_aggregate_period_4:
        condition: service_healthy
      q2_merge_period:
        condition: service_healthy
      q2_enrich_items:
        condition: service_healthy
      q2_sink:
        condition: service_healthy
      q3_aggregate_semester_0:
        condition: service_healthy
      q3_aggregate_semester_1:
        condition: service_healthy
      q3_aggregate_semester_2:
        condition: service_healthy
      q3_aggregate_semester_3:
        condition: service_healthy
      q3_aggregate_semester_4:
        condition: service_healthy
      q3_merge_semester:
        condition: service_healthy
      q3_enrich_stores:
        condition: service_healthy
      q3_sink:
        condition: service_healthy
      q4_aggregate_users_0:
        condition: service_healthy
      q4_aggregate_users_1:
        condition: service_healthy
      q4_aggregate_users_2:
        condition: service_healthy
      q4_aggregate_users_3:
        condition: service_healthy
      q4_aggregate_users_4:
        condition: service_healthy
      q4_enrich_users_0:
        condition: service_healthy
      q4_enrich_users_1:
        condition: service_healthy
      q4_enrich_users_2:
        condition: service_healthy
      q4_enrich_users_3:
        condition: service_healthy
      q4_enrich_users_4:
        condition: service_healthy
      q4_merge_top3:
        condition: service_healthy
      q4_enrich_stores:
        condition: service_healthy
      q4_sink:
        condition: service_healthy
  chaos_monkey:
    container_name: chaos_monkey
    build:
      context: .
      dockerfile: ./chaos_monkey/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    restart: on-failure
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./chaos_monkey:/chaos_monkey
    environment:
      CONTAINERS_EXCLUDED: gateway,chaos_monkey,rabbitmq,client_min,client_full,health,aggre,filter,transf,sink,merg
      KILL_INTERVAL: 5.0
      LOGGING_LEVEL: DEBUG
    depends_on:
      gateway:
        condition: service_started
  health_checker_0:
    container_name: health_checker_0
    build:
      context: .
      dockerfile: ./health_checker/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - hc_0_data:/state
    environment:
      REPLICA_ID: '0'
      REPLICAS: '3'
      CHECK_INTERVAL: '10'
      WORKER_PORT: '9090'
      WORKER_TIMEOUT: '15'
      WORKER_HEARTBEAT_INTERVAL: '5'
      PEER_PORT: '9091'
      PEER_HEARTBEAT_INTERVAL: '2'
      PEER_TIMEOUT: '4'
      ELECTION_TIMEOUT: '3'
      COORDINATOR_TIMEOUT: '5'
      PERSIST_PATH: /state/registry.json
  health_checker_1:
    container_name: health_checker_1
    build:
      context: .
      dockerfile: ./health_checker/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - hc_1_data:/state
    environment:
      REPLICA_ID: '1'
      REPLICAS: '3'
      CHECK_INTERVAL: '10'
      WORKER_PORT: '9090'
      WORKER_TIMEOUT: '15'
      WORKER_HEARTBEAT_INTERVAL: '5'
      PEER_PORT: '9091'
      PEER_HEARTBEAT_INTERVAL: '2'
      PEER_TIMEOUT: '4'
      ELECTION_TIMEOUT: '3'
      COORDINATOR_TIMEOUT: '5'
      PERSIST_PATH: /state/registry.json
  health_checker_2:
    container_name: health_checker_2
    build:
      context: .
      dockerfile: ./health_checker/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - hc_2_data:/state
    environment:
      REPLICA_ID: '2'
      REPLICAS: '3'
      CHECK_INTERVAL: '10'
      WORKER_PORT: '9090'
      WORKER_TIMEOUT: '15'
      WORKER_HEARTBEAT_INTERVAL: '5'
      PEER_PORT: '9091'
      PEER_HEARTBEAT_INTERVAL: '2'
      PEER_TIMEOUT: '4'
      ELECTION_TIMEOUT: '3'
      COORDINATOR_TIMEOUT: '5'
      PERSIST_PATH: /state/registry.json
  client_min:
    build:
      context: .
      dockerfile: ./client/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    depends_on:
    - gateway
    environment:
      LOGGING_LEVEL: DEBUG
    volumes:
    - ./.data/dataset_min:/client/.data
    - ./.results:/client/.results
    - ./client:/client
    - ./shared:/shared
    scale: 3
  transformer_menu_items:
    container_name: transformer_menu_items
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_menu_items-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: transformer_menu_items
      MODULE_NAME: menu
      FROM: raw_menu_items_batches
      TO: '[{"name": "menu_items_source", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_stores:
    container_name: transformer_stores
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_stores-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: transformer_stores
      MODULE_NAME: store
      FROM: raw_stores_batches
      TO: '[{"name": "stores_source", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_users_0:
    container_name: transformer_users_0
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_users-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: transformer_users
      MODULE_NAME: user
      FROM: raw_users_batches
      TO: '[{"name": "users_source", "downstream_stage": "q4_enrich_users", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_users_1:
    container_name: transformer_users_1
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_users-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: transformer_users
      MODULE_NAME: user
      FROM: raw_users_batches
      TO: '[{"name": "users_source", "downstream_stage": "q4_enrich_users", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_users_2:
    container_name: transformer_users_2
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_users-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: transformer_users
      MODULE_NAME: user
      FROM: raw_users_batches
      TO: '[{"name": "users_source", "downstream_stage": "q4_enrich_users", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_users_3:
    container_name: transformer_users_3
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_users-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: transformer_users
      MODULE_NAME: user
      FROM: raw_users_batches
      TO: '[{"name": "users_source", "downstream_stage": "q4_enrich_users", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_users_4:
    container_name: transformer_users_4
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_users-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: transformer_users
      MODULE_NAME: user
      FROM: raw_users_batches
      TO: '[{"name": "users_source", "downstream_stage": "q4_enrich_users", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transactions_0:
    container_name: transformer_transactions_0
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transactions-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: transformer_transactions
      MODULE_NAME: transaction
      FROM: raw_transactions_batches
      TO: '[{"name": "transactions_source", "downstream_stage": "q1_filter_year", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transactions_1:
    container_name: transformer_transactions_1
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transactions-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: transformer_transactions
      MODULE_NAME: transaction
      FROM: raw_transactions_batches
      TO: '[{"name": "transactions_source", "downstream_stage": "q1_filter_year", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transactions_2:
    container_name: transformer_transactions_2
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transactions-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: transformer_transactions
      MODULE_NAME: transaction
      FROM: raw_transactions_batches
      TO: '[{"name": "transactions_source", "downstream_stage": "q1_filter_year", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transactions_3:
    container_name: transformer_transactions_3
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transactions-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: transformer_transactions
      MODULE_NAME: transaction
      FROM: raw_transactions_batches
      TO: '[{"name": "transactions_source", "downstream_stage": "q1_filter_year", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transactions_4:
    container_name: transformer_transactions_4
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transactions-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: transformer_transactions
      MODULE_NAME: transaction
      FROM: raw_transactions_batches
      TO: '[{"name": "transactions_source", "downstream_stage": "q1_filter_year", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transaction_items_0:
    container_name: transformer_transaction_items_0
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transaction_items-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: transformer_transaction_items
      MODULE_NAME: transaction_item
      FROM: raw_transaction_items_batches
      TO: '[{"name": "transaction_items_source", "downstream_stage": "q2_filter_items", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transaction_items_1:
    container_name: transformer_transaction_items_1
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transaction_items-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: transformer_transaction_items
      MODULE_NAME: transaction_item
      FROM: raw_transaction_items_batches
      TO: '[{"name": "transaction_items_source", "downstream_stage": "q2_filter_items", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transaction_items_2:
    container_name: transformer_transaction_items_2
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transaction_items-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: transformer_transaction_items
      MODULE_NAME: transaction_item
      FROM: raw_transaction_items_batches
      TO: '[{"name": "transaction_items_source", "downstream_stage": "q2_filter_items", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transaction_items_3:
    container_name: transformer_transaction_items_3
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transaction_items-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: transformer_transaction_items
      MODULE_NAME: transaction_item
      FROM: raw_transaction_items_batches
      TO: '[{"name": "transaction_items_source", "downstream_stage": "q2_filter_items", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  transformer_transaction_items_4:
    container_name: transformer_transaction_items_4
    image: transformer_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformer/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/transformer_transaction_items-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: transformer_transaction_items
      MODULE_NAME: transaction_item
      FROM: raw_transaction_items_batches
      TO: '[{"name": "transaction_items_source", "downstream_stage": "q2_filter_items", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_year_0:
    container_name: q1_filter_year_0
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_year-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_year
      MODULE_NAME: year
      FROM: transactions_source
      TO: '[{"name": "q1.filtered_year", "downstream_stage": "q1_filter_hour", "downstream_workers": 5}, {"name": "q4.filtered_year", "downstream_stage": "q4_aggregate_users", "downstream_workers": 5, "routing_fn": "tx_router"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_year_1:
    container_name: q1_filter_year_1
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_year-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_year
      MODULE_NAME: year
      FROM: transactions_source
      TO: '[{"name": "q1.filtered_year", "downstream_stage": "q1_filter_hour", "downstream_workers": 5}, {"name": "q4.filtered_year", "downstream_stage": "q4_aggregate_users", "downstream_workers": 5, "routing_fn": "tx_router"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_year_2:
    container_name: q1_filter_year_2
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_year-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_year
      MODULE_NAME: year
      FROM: transactions_source
      TO: '[{"name": "q1.filtered_year", "downstream_stage": "q1_filter_hour", "downstream_workers": 5}, {"name": "q4.filtered_year", "downstream_stage": "q4_aggregate_users", "downstream_workers": 5, "routing_fn": "tx_router"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_year_3:
    container_name: q1_filter_year_3
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_year-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_year
      MODULE_NAME: year
      FROM: transactions_source
      TO: '[{"name": "q1.filtered_year", "downstream_stage": "q1_filter_hour", "downstream_workers": 5}, {"name": "q4.filtered_year", "downstream_stage": "q4_aggregate_users", "downstream_workers": 5, "routing_fn": "tx_router"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_year_4:
    container_name: q1_filter_year_4
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_year-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_year
      MODULE_NAME: year
      FROM: transactions_source
      TO: '[{"name": "q1.filtered_year", "downstream_stage": "q1_filter_hour", "downstream_workers": 5}, {"name": "q4.filtered_year", "downstream_stage": "q4_aggregate_users", "downstream_workers": 5, "routing_fn": "tx_router"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_hour_0:
    container_name: q1_filter_hour_0
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_hour-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_hour
      MODULE_NAME: hour
      FROM: q1.filtered_year
      TO: '[{"name": "q1.filtered_hour", "downstream_stage": "q1_filter_amount", "downstream_workers": 5}, {"name": "q3.filtered_hour", "downstream_stage": "q3_aggregate_semester", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_hour_1:
    container_name: q1_filter_hour_1
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_hour-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_hour
      MODULE_NAME: hour
      FROM: q1.filtered_year
      TO: '[{"name": "q1.filtered_hour", "downstream_stage": "q1_filter_amount", "downstream_workers": 5}, {"name": "q3.filtered_hour", "downstream_stage": "q3_aggregate_semester", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_hour_2:
    container_name: q1_filter_hour_2
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_hour-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_hour
      MODULE_NAME: hour
      FROM: q1.filtered_year
      TO: '[{"name": "q1.filtered_hour", "downstream_stage": "q1_filter_amount", "downstream_workers": 5}, {"name": "q3.filtered_hour", "downstream_stage": "q3_aggregate_semester", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_hour_3:
    container_name: q1_filter_hour_3
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_hour-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_hour
      MODULE_NAME: hour
      FROM: q1.filtered_year
      TO: '[{"name": "q1.filtered_hour", "downstream_stage": "q1_filter_amount", "downstream_workers": 5}, {"name": "q3.filtered_hour", "downstream_stage": "q3_aggregate_semester", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_hour_4:
    container_name: q1_filter_hour_4
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_hour-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_hour
      MODULE_NAME: hour
      FROM: q1.filtered_year
      TO: '[{"name": "q1.filtered_hour", "downstream_stage": "q1_filter_amount", "downstream_workers": 5}, {"name": "q3.filtered_hour", "downstream_stage": "q3_aggregate_semester", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_amount_0:
    container_name: q1_filter_amount_0
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_amount-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_amount
      MODULE_NAME: amount
      FROM: q1.filtered_hour
      TO: '[{"name": "q1.filtered_amount", "downstream_stage": "q1_sink", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_amount_1:
    container_name: q1_filter_amount_1
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_amount-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_amount
      MODULE_NAME: amount
      FROM: q1.filtered_hour
      TO: '[{"name": "q1.filtered_amount", "downstream_stage": "q1_sink", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_amount_2:
    container_name: q1_filter_amount_2
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_amount-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_amount
      MODULE_NAME: amount
      FROM: q1.filtered_hour
      TO: '[{"name": "q1.filtered_amount", "downstream_stage": "q1_sink", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_amount_3:
    container_name: q1_filter_amount_3
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_amount-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_amount
      MODULE_NAME: amount
      FROM: q1.filtered_hour
      TO: '[{"name": "q1.filtered_amount", "downstream_stage": "q1_sink", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_filter_amount_4:
    container_name: q1_filter_amount_4
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_filter_amount-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q1_filter_amount
      MODULE_NAME: amount
      FROM: q1.filtered_hour
      TO: '[{"name": "q1.filtered_amount", "downstream_stage": "q1_sink", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q1_sink:
    container_name: q1_sink
    image: sink_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sink/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q1_sink-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q1_sink
      MODULE_NAME: sink_q1
      FROM: q1.filtered_amount
      TO: '[{"name": "results", "downstream_stage": "q1", "downstream_workers": 1, "routing_fn": "by_stage_name"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_filter_items_0:
    container_name: q2_filter_items_0
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_filter_items-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q2_filter_items
      MODULE_NAME: item_year
      FROM: transaction_items_source
      TO: '[{"name": "q2.filtered_items", "downstream_stage": "q2_aggregate_period", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_filter_items_1:
    container_name: q2_filter_items_1
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_filter_items-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q2_filter_items
      MODULE_NAME: item_year
      FROM: transaction_items_source
      TO: '[{"name": "q2.filtered_items", "downstream_stage": "q2_aggregate_period", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_filter_items_2:
    container_name: q2_filter_items_2
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_filter_items-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q2_filter_items
      MODULE_NAME: item_year
      FROM: transaction_items_source
      TO: '[{"name": "q2.filtered_items", "downstream_stage": "q2_aggregate_period", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_filter_items_3:
    container_name: q2_filter_items_3
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_filter_items-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q2_filter_items
      MODULE_NAME: item_year
      FROM: transaction_items_source
      TO: '[{"name": "q2.filtered_items", "downstream_stage": "q2_aggregate_period", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_filter_items_4:
    container_name: q2_filter_items_4
    image: filter_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filter/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_filter_items-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q2_filter_items
      MODULE_NAME: item_year
      FROM: transaction_items_source
      TO: '[{"name": "q2.filtered_items", "downstream_stage": "q2_aggregate_period", "downstream_workers": 5}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_aggregate_period_0:
    container_name: q2_aggregate_period_0
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_aggregate_period-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q2_aggregate_period
      MODULE_NAME: period_agg
      FROM: q2.filtered_items
      TO: '[{"name": "q2.aggregated_period", "downstream_stage": "q2_merge_period", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_aggregate_period_1:
    container_name: q2_aggregate_period_1
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_aggregate_period-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q2_aggregate_period
      MODULE_NAME: period_agg
      FROM: q2.filtered_items
      TO: '[{"name": "q2.aggregated_period", "downstream_stage": "q2_merge_period", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_aggregate_period_2:
    container_name: q2_aggregate_period_2
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_aggregate_period-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q2_aggregate_period
      MODULE_NAME: period_agg
      FROM: q2.filtered_items
      TO: '[{"name": "q2.aggregated_period", "downstream_stage": "q2_merge_period", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_aggregate_period_3:
    container_name: q2_aggregate_period_3
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_aggregate_period-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q2_aggregate_period
      MODULE_NAME: period_agg
      FROM: q2.filtered_items
      TO: '[{"name": "q2.aggregated_period", "downstream_stage": "q2_merge_period", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_aggregate_period_4:
    container_name: q2_aggregate_period_4
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_aggregate_period-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q2_aggregate_period
      MODULE_NAME: period_agg
      FROM: q2.filtered_items
      TO: '[{"name": "q2.aggregated_period", "downstream_stage": "q2_merge_period", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_merge_period:
    container_name: q2_merge_period
    image: merger_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/merger/merger_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_merge_period-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q2_merge_period
      MODULE_NAME: period_merge
      FROM: q2.aggregated_period
      TO: '[{"name": "q2.merged_period", "downstream_stage": "q2_enrich_items", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_enrich_items:
    container_name: q2_enrich_items
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_enrich_items-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q2_enrich_items
      MODULE_NAME: item_enricher
      FROM: q2.merged_period
      TO: '[{"name": "q2.enriched_items", "downstream_stage": "q2_sink", "downstream_workers": 1}]'
      ENRICHER: menu_items_source
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q2_sink:
    container_name: q2_sink
    image: sink_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sink/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q2_sink-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q2_sink
      MODULE_NAME: sink_q2
      FROM: q2.enriched_items
      TO: '[{"name": "results", "downstream_stage": "q2", "downstream_workers": 1, "routing_fn": "by_stage_name"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_aggregate_semester_0:
    container_name: q3_aggregate_semester_0
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_aggregate_semester-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q3_aggregate_semester
      MODULE_NAME: semester_agg
      FROM: q3.filtered_hour
      TO: '[{"name": "q3.aggregated_semester", "downstream_stage": "q3_merge_semester", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_aggregate_semester_1:
    container_name: q3_aggregate_semester_1
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_aggregate_semester-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q3_aggregate_semester
      MODULE_NAME: semester_agg
      FROM: q3.filtered_hour
      TO: '[{"name": "q3.aggregated_semester", "downstream_stage": "q3_merge_semester", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_aggregate_semester_2:
    container_name: q3_aggregate_semester_2
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_aggregate_semester-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q3_aggregate_semester
      MODULE_NAME: semester_agg
      FROM: q3.filtered_hour
      TO: '[{"name": "q3.aggregated_semester", "downstream_stage": "q3_merge_semester", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_aggregate_semester_3:
    container_name: q3_aggregate_semester_3
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_aggregate_semester-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q3_aggregate_semester
      MODULE_NAME: semester_agg
      FROM: q3.filtered_hour
      TO: '[{"name": "q3.aggregated_semester", "downstream_stage": "q3_merge_semester", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_aggregate_semester_4:
    container_name: q3_aggregate_semester_4
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_aggregate_semester-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q3_aggregate_semester
      MODULE_NAME: semester_agg
      FROM: q3.filtered_hour
      TO: '[{"name": "q3.aggregated_semester", "downstream_stage": "q3_merge_semester", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_merge_semester:
    container_name: q3_merge_semester
    image: merger_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/merger/merger_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_merge_semester-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q3_merge_semester
      MODULE_NAME: semester_merge
      FROM: q3.aggregated_semester
      TO: '[{"name": "q3.merged_semester", "downstream_stage": "q3_enrich_stores", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_enrich_stores:
    container_name: q3_enrich_stores
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_enrich_stores-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q3_enrich_stores
      MODULE_NAME: store_enricher
      FROM: q3.merged_semester
      TO: '[{"name": "q3.enriched_stores", "downstream_stage": "q3_sink", "downstream_workers": 1}]'
      ENRICHER: stores_source
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q3_sink:
    container_name: q3_sink
    image: sink_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sink/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q3_sink-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q3_sink
      MODULE_NAME: sink_q3
      FROM: q3.enriched_stores
      TO: '[{"name": "results", "downstream_stage": "q3", "downstream_workers": 1, "routing_fn": "by_stage_name"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_aggregate_users_0:
    container_name: q4_aggregate_users_0
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_aggregate_users-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q4_aggregate_users
      MODULE_NAME: user_purchase_aggregator
      FROM: q4.filtered_year
      TO: '[{"name": "q4.aggregated_users", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_aggregate_users_1:
    container_name: q4_aggregate_users_1
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_aggregate_users-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q4_aggregate_users
      MODULE_NAME: user_purchase_aggregator
      FROM: q4.filtered_year
      TO: '[{"name": "q4.aggregated_users", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_aggregate_users_2:
    container_name: q4_aggregate_users_2
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_aggregate_users-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q4_aggregate_users
      MODULE_NAME: user_purchase_aggregator
      FROM: q4.filtered_year
      TO: '[{"name": "q4.aggregated_users", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_aggregate_users_3:
    container_name: q4_aggregate_users_3
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_aggregate_users-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q4_aggregate_users
      MODULE_NAME: user_purchase_aggregator
      FROM: q4.filtered_year
      TO: '[{"name": "q4.aggregated_users", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_aggregate_users_4:
    container_name: q4_aggregate_users_4
    image: aggregator_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregator/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_aggregate_users-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q4_aggregate_users
      MODULE_NAME: user_purchase_aggregator
      FROM: q4.filtered_year
      TO: '[{"name": "q4.aggregated_users", "routing_fn": "broadcast"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_enrich_users_0:
    container_name: q4_enrich_users_0
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_enrich_users-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      STAGE_NAME: q4_enrich_users
      MODULE_NAME: user_enricher
      FROM: users_source
      TO: '[{"name": "q4.enriched_users", "downstream_stage": "q4_merge_top3", "downstream_workers": 1}]'
      ENRICHER: q4.aggregated_users
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_enrich_users_1:
    container_name: q4_enrich_users_1
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_enrich_users-1:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      STAGE_NAME: q4_enrich_users
      MODULE_NAME: user_enricher
      FROM: users_source
      TO: '[{"name": "q4.enriched_users", "downstream_stage": "q4_merge_top3", "downstream_workers": 1}]'
      ENRICHER: q4.aggregated_users
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_enrich_users_2:
    container_name: q4_enrich_users_2
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_enrich_users-2:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      STAGE_NAME: q4_enrich_users
      MODULE_NAME: user_enricher
      FROM: users_source
      TO: '[{"name": "q4.enriched_users", "downstream_stage": "q4_merge_top3", "downstream_workers": 1}]'
      ENRICHER: q4.aggregated_users
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_enrich_users_3:
    container_name: q4_enrich_users_3
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_enrich_users-3:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      STAGE_NAME: q4_enrich_users
      MODULE_NAME: user_enricher
      FROM: users_source
      TO: '[{"name": "q4.enriched_users", "downstream_stage": "q4_merge_top3", "downstream_workers": 1}]'
      ENRICHER: q4.aggregated_users
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_enrich_users_4:
    container_name: q4_enrich_users_4
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_enrich_users-4:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      STAGE_NAME: q4_enrich_users
      MODULE_NAME: user_enricher
      FROM: users_source
      TO: '[{"name": "q4.enriched_users", "downstream_stage": "q4_merge_top3", "downstream_workers": 1}]'
      ENRICHER: q4.aggregated_users
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_merge_top3:
    container_name: q4_merge_top3
    image: merger_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/merger/merger_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_merge_top3-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q4_merge_top3
      MODULE_NAME: top_3
      FROM: q4.enriched_users
      TO: '[{"name": "q4.merged_top3", "downstream_stage": "q4_enrich_stores", "downstream_workers": 1}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_enrich_stores:
    container_name: q4_enrich_stores
    image: enricher_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enricher/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_enrich_stores-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q4_enrich_stores
      MODULE_NAME: store_enricher_q4
      FROM: q4.merged_top3
      TO: '[{"name": "q4.enriched_stores", "downstream_stage": "q4_sink", "downstream_workers": 1}]'
      ENRICHER: stores_source
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
  q4_sink:
    container_name: q4_sink
    image: sink_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sink/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
      health_checker_0:
        condition: service_started
      health_checker_1:
        condition: service_started
      health_checker_2:
        condition: service_started
    volumes:
    - ./.saved_sessions/q4_sink-0:/sessions
    - ./worker:/worker
    - ./shared:/shared
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      STAGE_NAME: q4_sink
      MODULE_NAME: sink_q4
      FROM: q4.enriched_stores
      TO: '[{"name": "results", "downstream_stage": "q4", "downstream_workers": 1, "routing_fn": "by_stage_name"}]'
      HEALTH_CHECKER_REPLICAS: '3'
      HEALTH_CHECKER_PORT: '9090'
      HEARTBEAT_INTERVAL: '5'
    healthcheck:
      test: test -f /tmp/ready
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
volumes:
  rabbitmq-volume: null
  hc_0_data: null
  hc_1_data: null
  hc_2_data: null
networks:
  coffee:
    driver: bridge
