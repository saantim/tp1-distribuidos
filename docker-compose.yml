name: coffee-shop-analyzer

services:

  gateway:
    container_name: coffee-gateway
    build:
      context: .
      dockerfile: ./gateway/Dockerfile
    entrypoint: python main.py
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy

# Client

  demux:
    image: demux_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/demux/demux_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=INFO
      - MIDDLEWARE_HOST=rabbitmq
      - FROM=demux_queue
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 1

  filter_amount:
    image: filter_amount
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=filtered_tx_6am_11pm
      - TO_TYPE=QUEUE
      - TO=filtered_amount
      - MODULE_NAME=filter_amount
      - REPLICAS=2
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 2

  filter_tx_2024_2025:
    image: filter_amount
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=transactions_source
      - TO_TYPE=QUEUE
      - TO=filtered_tx_2024_2025
      - MODULE_NAME=filter_tx_2024_2025
      - REPLICAS=2
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 2

  filter_tx_item_2024_2025:
    image: filter_amount
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=transaction_items_queue
      - TO_TYPE=QUEUE
      - TO=filtered_item_amount
      - MODULE_NAME=filter_tx_item_2024_2025
      - REPLICAS=1
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 1

  filter_tx_6am_11pm:
    image: filter_amount
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=filtered_tx_2024_2025
      - TO_TYPE=QUEUE
      - TO=filtered_tx_6am_11pm
      - MODULE_NAME=filter_tx_6am_11pm
      - REPLICAS=2
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 2

  aggregator_period:
    image: aggregator_period
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=filtered_item_amount
      - TO_TYPE=QUEUE
      - TO=aggregated_item_by_period
      - MODULE_NAME=period_aggregator
      - REPLICAS=1
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 1

  enricher_item:
    image: enricher_item
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=merged_item_by_period
      - ENRICHER_TYPE=EXCHANGE
      - ENRICHER_STRATEGY=FANOUT
      - ENRICHER=menu_items_queue
      - TO_TYPE=QUEUE
      - TO=enriched_item_by_period
      - MODULE_NAME=item_enricher
      - REPLICAS=1
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 1

  merger_period:
    image: merger_period
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/mergers/merger_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=DEBUG
      - MIDDLEWARE_HOST=rabbitmq
      - FROM_TYPE=QUEUE
      - FROM=aggregated_item_by_period
      - TO_TYPE=QUEUE
      - TO=merged_item_by_period
      - MODULE_NAME=merge_period_results
      - REPLICAS=1
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
    scale: 1

  sink_q1:
    image: sink_worker
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sinks/sink_main.py
    environment:
      - PYTHONUNBUFFERED=1
      - LOGGING_LEVEL=INFO
      - MIDDLEWARE_HOST=rabbitmq
      - FROM=filtered_amount
      - RESULTS_QUEUE=results_q1
      - MODULE_NAME=sink_q1
      - STREAM_MODE=true
    networks:
      - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy

  rabbitmq:
    container_name: rabbitmq-container
    image: rabbitmq:4.1.4-management
    volumes:
      - rabbitmq-volume:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
      - RABBITMQ_NODENAME=rabbit@rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - "5672:5672"
      - "8080:15672"
    networks:
      - coffee

volumes:
  rabbitmq-volume:

networks:
  coffee:
    driver: bridge
