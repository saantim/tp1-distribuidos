name: coffee-shop-analyzer
services:
  gateway:
    container_name: gateway
    build:
      context: .
      dockerfile: ./gateway/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  client:
    container_name: client
    build:
      context: .
      dockerfile: ./client/Dockerfile
    entrypoint: python main.py
    networks:
    - coffee
    depends_on:
    - gateway
    environment:
      LOGGING_LEVEL: DEBUG
    volumes:
    - ./.data/dataset_min:/client/.data
    - ./.results:/client/.results
  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:4.1.4-management
    volumes:
    - rabbitmq-volume:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      RABBITMQ_NODENAME: rabbit@rabbitmq
    networks:
    - coffee
    ports:
    - 5672:5672
    - 8080:15672
    healthcheck:
      test: rabbitmq-diagnostics -q check_running && rabbitmq-diagnostics -q check_local_alarms && rabbitmq-diagnostics -q check_port_connectivity
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 40s
  transformer_menu_0:
    container_name: transformer_menu_0
    image: transformer_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      MODULE_NAME: menu
      FROM: '[["QUEUE", "raw_menu_items_batches"]]'
      TO: '[["EXCHANGE", "menu_items_source", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_store_0:
    container_name: transformer_store_0
    image: transformer_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      MODULE_NAME: store
      FROM: '[["QUEUE", "raw_stores_batches"]]'
      TO: '[["EXCHANGE", "stores_source", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_user_0:
    container_name: transformer_user_0
    image: transformer_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '3'
      MODULE_NAME: user
      FROM: '[["QUEUE", "raw_users_batches"]]'
      TO: '[["QUEUE", "users_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_user_1:
    container_name: transformer_user_1
    image: transformer_worker
    environment:
      REPLICA_ID: '1'
      REPLICAS: '3'
      MODULE_NAME: user
      FROM: '[["QUEUE", "raw_users_batches"]]'
      TO: '[["QUEUE", "users_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_user_2:
    container_name: transformer_user_2
    image: transformer_worker
    environment:
      REPLICA_ID: '2'
      REPLICAS: '3'
      MODULE_NAME: user
      FROM: '[["QUEUE", "raw_users_batches"]]'
      TO: '[["QUEUE", "users_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_transaction_0:
    container_name: transformer_transaction_0
    image: transformer_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '3'
      MODULE_NAME: transaction
      FROM: '[["QUEUE", "raw_transactions_batches"]]'
      TO: '[["QUEUE", "transactions_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_transaction_1:
    container_name: transformer_transaction_1
    image: transformer_worker
    environment:
      REPLICA_ID: '1'
      REPLICAS: '3'
      MODULE_NAME: transaction
      FROM: '[["QUEUE", "raw_transactions_batches"]]'
      TO: '[["QUEUE", "transactions_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_transaction_2:
    container_name: transformer_transaction_2
    image: transformer_worker
    environment:
      REPLICA_ID: '2'
      REPLICAS: '3'
      MODULE_NAME: transaction
      FROM: '[["QUEUE", "raw_transactions_batches"]]'
      TO: '[["QUEUE", "transactions_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_tx_items_0:
    container_name: transformer_tx_items_0
    image: transformer_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '5'
      MODULE_NAME: transaction_item
      FROM: '[["QUEUE", "raw_transaction_items_batches"]]'
      TO: '[["QUEUE", "transaction_items_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_tx_items_1:
    container_name: transformer_tx_items_1
    image: transformer_worker
    environment:
      REPLICA_ID: '1'
      REPLICAS: '5'
      MODULE_NAME: transaction_item
      FROM: '[["QUEUE", "raw_transaction_items_batches"]]'
      TO: '[["QUEUE", "transaction_items_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_tx_items_2:
    container_name: transformer_tx_items_2
    image: transformer_worker
    environment:
      REPLICA_ID: '2'
      REPLICAS: '5'
      MODULE_NAME: transaction_item
      FROM: '[["QUEUE", "raw_transaction_items_batches"]]'
      TO: '[["QUEUE", "transaction_items_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_tx_items_3:
    container_name: transformer_tx_items_3
    image: transformer_worker
    environment:
      REPLICA_ID: '3'
      REPLICAS: '5'
      MODULE_NAME: transaction_item
      FROM: '[["QUEUE", "raw_transaction_items_batches"]]'
      TO: '[["QUEUE", "transaction_items_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  transformer_tx_items_4:
    container_name: transformer_tx_items_4
    image: transformer_worker
    environment:
      REPLICA_ID: '4'
      REPLICAS: '5'
      MODULE_NAME: transaction_item
      FROM: '[["QUEUE", "raw_transaction_items_batches"]]'
      TO: '[["QUEUE", "transaction_items_source"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/transformers/transformer_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_2024_2025_0:
    container_name: filter_tx_2024_2025_0
    image: filter_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "transactions_source"]]'
      TO: '[["QUEUE", "filtered_tx_2024_2025_q1"], ["QUEUE", "filtered_tx_2024_2025_q4"]]'
      MODULE_NAME: year
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_2024_2025_1:
    container_name: filter_tx_2024_2025_1
    image: filter_worker
    environment:
      REPLICA_ID: '1'
      FROM: '[["QUEUE", "transactions_source"]]'
      TO: '[["QUEUE", "filtered_tx_2024_2025_q1"], ["QUEUE", "filtered_tx_2024_2025_q4"]]'
      MODULE_NAME: year
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_2024_2025_2:
    container_name: filter_tx_2024_2025_2
    image: filter_worker
    environment:
      REPLICA_ID: '2'
      FROM: '[["QUEUE", "transactions_source"]]'
      TO: '[["QUEUE", "filtered_tx_2024_2025_q1"], ["QUEUE", "filtered_tx_2024_2025_q4"]]'
      MODULE_NAME: year
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_6am_11pm_0:
    container_name: filter_tx_6am_11pm_0
    image: filter_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "filtered_tx_2024_2025_q1"]]'
      TO: '[["QUEUE", "filtered_tx_6am_11pm_q1"], ["QUEUE", "filtered_tx_6am_11pm_q3"]]'
      MODULE_NAME: hour
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_6am_11pm_1:
    container_name: filter_tx_6am_11pm_1
    image: filter_worker
    environment:
      REPLICA_ID: '1'
      FROM: '[["QUEUE", "filtered_tx_2024_2025_q1"]]'
      TO: '[["QUEUE", "filtered_tx_6am_11pm_q1"], ["QUEUE", "filtered_tx_6am_11pm_q3"]]'
      MODULE_NAME: hour
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_6am_11pm_2:
    container_name: filter_tx_6am_11pm_2
    image: filter_worker
    environment:
      REPLICA_ID: '2'
      FROM: '[["QUEUE", "filtered_tx_2024_2025_q1"]]'
      TO: '[["QUEUE", "filtered_tx_6am_11pm_q1"], ["QUEUE", "filtered_tx_6am_11pm_q3"]]'
      MODULE_NAME: hour
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_amount_0:
    container_name: filter_amount_0
    image: filter_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "filtered_tx_6am_11pm_q1"]]'
      TO: '[["QUEUE", "filtered_amount"]]'
      MODULE_NAME: amount
      REPLICAS: '2'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_amount_1:
    container_name: filter_amount_1
    image: filter_worker
    environment:
      REPLICA_ID: '1'
      FROM: '[["QUEUE", "filtered_tx_6am_11pm_q1"]]'
      TO: '[["QUEUE", "filtered_amount"]]'
      MODULE_NAME: amount
      REPLICAS: '2'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  sink_q1_0:
    container_name: sink_q1_0
    image: sink_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "filtered_amount"]]'
      TO: '[["QUEUE", "results_q1"]]'
      MODULE_NAME: sink_q1
      REPLICAS: '1'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sinks/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_item_2024_2025_0:
    container_name: filter_tx_item_2024_2025_0
    image: filter_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "transaction_items_source"]]'
      TO: '[["QUEUE", "filtered_item_amount"]]'
      MODULE_NAME: item_year
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_item_2024_2025_1:
    container_name: filter_tx_item_2024_2025_1
    image: filter_worker
    environment:
      REPLICA_ID: '1'
      FROM: '[["QUEUE", "transaction_items_source"]]'
      TO: '[["QUEUE", "filtered_item_amount"]]'
      MODULE_NAME: item_year
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  filter_tx_item_2024_2025_2:
    container_name: filter_tx_item_2024_2025_2
    image: filter_worker
    environment:
      REPLICA_ID: '2'
      FROM: '[["QUEUE", "transaction_items_source"]]'
      TO: '[["QUEUE", "filtered_item_amount"]]'
      MODULE_NAME: item_year
      REPLICAS: '3'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/filters/filter_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_period_0:
    container_name: aggregator_period_0
    image: aggregator_worker
    environment:
      REPLICA_ID: '0'
      MODULE_NAME: period_agg
      REPLICAS: '5'
      FROM: '[["QUEUE", "filtered_item_amount"]]'
      TO: '[["QUEUE", "aggregated_item_by_period"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_period_1:
    container_name: aggregator_period_1
    image: aggregator_worker
    environment:
      REPLICA_ID: '1'
      MODULE_NAME: period_agg
      REPLICAS: '5'
      FROM: '[["QUEUE", "filtered_item_amount"]]'
      TO: '[["QUEUE", "aggregated_item_by_period"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_period_2:
    container_name: aggregator_period_2
    image: aggregator_worker
    environment:
      REPLICA_ID: '2'
      MODULE_NAME: period_agg
      REPLICAS: '5'
      FROM: '[["QUEUE", "filtered_item_amount"]]'
      TO: '[["QUEUE", "aggregated_item_by_period"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_period_3:
    container_name: aggregator_period_3
    image: aggregator_worker
    environment:
      REPLICA_ID: '3'
      MODULE_NAME: period_agg
      REPLICAS: '5'
      FROM: '[["QUEUE", "filtered_item_amount"]]'
      TO: '[["QUEUE", "aggregated_item_by_period"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_period_4:
    container_name: aggregator_period_4
    image: aggregator_worker
    environment:
      REPLICA_ID: '4'
      MODULE_NAME: period_agg
      REPLICAS: '5'
      FROM: '[["QUEUE", "filtered_item_amount"]]'
      TO: '[["QUEUE", "aggregated_item_by_period"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  merger_period_0:
    container_name: merger_period_0
    image: merger_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      FROM: '[["QUEUE", "aggregated_item_by_period"]]'
      TO: '[["QUEUE", "merged_item_by_period"]]'
      MODULE_NAME: period_merge
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/mergers/merger_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  enricher_item_0:
    container_name: enricher_item_0
    image: enricher_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      MODULE_NAME: item_enricher
      FROM: '[["QUEUE", "merged_item_by_period"]]'
      TO: '[["QUEUE", "enriched_item_by_level"]]'
      ENRICHER: '[["EXCHANGE", "menu_items_source", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  sink_q2_0:
    container_name: sink_q2_0
    image: sink_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "enriched_item_by_level"]]'
      TO: '[["QUEUE", "results_q2"]]'
      MODULE_NAME: sink_q2
      REPLICAS: '1'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sinks/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  semester_aggregator_0:
    container_name: semester_aggregator_0
    image: aggregator_worker
    environment:
      REPLICA_ID: '0'
      MODULE_NAME: semester_agg
      REPLICAS: '3'
      FROM: '[["QUEUE", "filtered_tx_6am_11pm_q3"]]'
      TO: '[["QUEUE", "aggregated_semester_by_store"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  semester_aggregator_1:
    container_name: semester_aggregator_1
    image: aggregator_worker
    environment:
      REPLICA_ID: '1'
      MODULE_NAME: semester_agg
      REPLICAS: '3'
      FROM: '[["QUEUE", "filtered_tx_6am_11pm_q3"]]'
      TO: '[["QUEUE", "aggregated_semester_by_store"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  semester_aggregator_2:
    container_name: semester_aggregator_2
    image: aggregator_worker
    environment:
      REPLICA_ID: '2'
      MODULE_NAME: semester_agg
      REPLICAS: '3'
      FROM: '[["QUEUE", "filtered_tx_6am_11pm_q3"]]'
      TO: '[["QUEUE", "aggregated_semester_by_store"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  merger_semester_results_0:
    container_name: merger_semester_results_0
    image: merger_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      FROM: '[["QUEUE", "aggregated_semester_by_store"]]'
      TO: '[["QUEUE", "merged_semester_by_store"]]'
      MODULE_NAME: semester_merge
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/mergers/merger_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  enricher_semester_tx_0:
    container_name: enricher_semester_tx_0
    image: enricher_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      MODULE_NAME: store_enricher
      FROM: '[["QUEUE", "merged_semester_by_store"]]'
      TO: '[["QUEUE", "enriched_semester_tx"]]'
      ENRICHER: '[["EXCHANGE", "stores_source", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  sink_q3_0:
    container_name: sink_q3_0
    image: sink_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "enriched_semester_tx"]]'
      TO: '[["QUEUE", "results_q3"]]'
      MODULE_NAME: sink_q3
      REPLICAS: '1'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sinks/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  router_0:
    container_name: router_0
    image: router_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '3'
      MODULE_NAME: router_transactions_q4
      FROM: '[["QUEUE", "filtered_tx_2024_2025_q4"]]'
      TO: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_0", "tx_filtered_q4_1", "tx_filtered_q4_2", "tx_filtered_q4_3", "tx_filtered_q4_4"]], ["QUEUE", "tx_filtered_q4"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/router/router_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  router_1:
    container_name: router_1
    image: router_worker
    environment:
      REPLICA_ID: '1'
      REPLICAS: '3'
      MODULE_NAME: router_transactions_q4
      FROM: '[["QUEUE", "filtered_tx_2024_2025_q4"]]'
      TO: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_0", "tx_filtered_q4_1", "tx_filtered_q4_2", "tx_filtered_q4_3", "tx_filtered_q4_4"]], ["QUEUE", "tx_filtered_q4"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/router/router_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  router_2:
    container_name: router_2
    image: router_worker
    environment:
      REPLICA_ID: '2'
      REPLICAS: '3'
      MODULE_NAME: router_transactions_q4
      FROM: '[["QUEUE", "filtered_tx_2024_2025_q4"]]'
      TO: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_0", "tx_filtered_q4_1", "tx_filtered_q4_2", "tx_filtered_q4_3", "tx_filtered_q4_4"]], ["QUEUE", "tx_filtered_q4"]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/router/router_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_user_purchase_0:
    container_name: aggregator_user_purchase_0
    image: aggregator_worker
    environment:
      REPLICA_ID: '0'
      MODULE_NAME: user_purchase_aggregator
      REPLICAS: '5'
      FROM: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_0"]]]'
      TO: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_user_purchase_1:
    container_name: aggregator_user_purchase_1
    image: aggregator_worker
    environment:
      REPLICA_ID: '1'
      MODULE_NAME: user_purchase_aggregator
      REPLICAS: '5'
      FROM: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_1"]]]'
      TO: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_user_purchase_2:
    container_name: aggregator_user_purchase_2
    image: aggregator_worker
    environment:
      REPLICA_ID: '2'
      MODULE_NAME: user_purchase_aggregator
      REPLICAS: '5'
      FROM: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_2"]]]'
      TO: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_user_purchase_3:
    container_name: aggregator_user_purchase_3
    image: aggregator_worker
    environment:
      REPLICA_ID: '3'
      MODULE_NAME: user_purchase_aggregator
      REPLICAS: '5'
      FROM: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_3"]]]'
      TO: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  aggregator_user_purchase_4:
    container_name: aggregator_user_purchase_4
    image: aggregator_worker
    environment:
      REPLICA_ID: '4'
      MODULE_NAME: user_purchase_aggregator
      REPLICAS: '5'
      FROM: '[["EXCHANGE", "tx_filtered_q4", "DIRECT", ["tx_filtered_q4_4"]]]'
      TO: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/aggregators/aggregator_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  user_enricher_tx_0:
    container_name: user_enricher_tx_0
    image: enricher_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '3'
      MODULE_NAME: user_enricher
      FROM: '[["QUEUE", "users_source"]]'
      TO: '[["QUEUE", "enriched_store_user_top3"]]'
      ENRICHER: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  user_enricher_tx_1:
    container_name: user_enricher_tx_1
    image: enricher_worker
    environment:
      REPLICA_ID: '1'
      REPLICAS: '3'
      MODULE_NAME: user_enricher
      FROM: '[["QUEUE", "users_source"]]'
      TO: '[["QUEUE", "enriched_store_user_top3"]]'
      ENRICHER: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  user_enricher_tx_2:
    container_name: user_enricher_tx_2
    image: enricher_worker
    environment:
      REPLICA_ID: '2'
      REPLICAS: '3'
      MODULE_NAME: user_enricher
      FROM: '[["QUEUE", "users_source"]]'
      TO: '[["QUEUE", "enriched_store_user_top3"]]'
      ENRICHER: '[["EXCHANGE", "user_purchase_aggregated", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  merger_final_top3_0:
    container_name: merger_final_top3_0
    image: merger_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      FROM: '[["QUEUE", "enriched_store_user_top3"]]'
      TO: '[["QUEUE", "enriched_final_top3"]]'
      MODULE_NAME: top_3
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/mergers/merger_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  store_enricher_tx_0:
    container_name: store_enricher_tx_0
    image: enricher_worker
    environment:
      REPLICA_ID: '0'
      REPLICAS: '1'
      MODULE_NAME: store_enricher_q4
      FROM: '[["QUEUE", "enriched_final_top3"]]'
      TO: '[["QUEUE", "top3_users_store_enriched"]]'
      ENRICHER: '[["EXCHANGE", "stores_source", "FANOUT", ["common"]]]'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/enrichers/enricher_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
  sink_q4_0:
    container_name: sink_q4_0
    image: sink_worker
    environment:
      REPLICA_ID: '0'
      FROM: '[["QUEUE", "top3_users_store_enriched"]]'
      TO: '[["QUEUE", "results_q4"]]'
      MODULE_NAME: sink_q4
      REPLICAS: '1'
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    entrypoint: python /worker/sinks/sink_main.py
    networks:
    - coffee
    depends_on:
      rabbitmq:
        condition: service_healthy
volumes:
  rabbitmq-volume: null
networks:
  coffee:
    driver: bridge
