settings:
  rabbitmq:
    version: "4.1.4-management"
    user: "admin"
    password: "admin"
  clients:
    min: 10
    full: 0
  chaos_monkey:
    enabled: true
    filter_prefix: "gateway,chaos_monkey,rabbitmq,client_min,client_full"
    full:
      enabled: true
      interval: 60
    single:
      enabled: true
      interval: 5
    start_delay: 20
    logging_level: DEBUG
  health_checker:
    enabled: true
    replicas: 3
    check_interval: 3
    worker:
      port: 9090
      timeout: 15
      heartbeat_interval: 5
    peer:
      port: 9091
      heartbeat_interval: 2
      timeout: 4
    election:
      timeout: 3
      coordinator_timeout: 5

transformers:
  menu_items:
    module: "menu"
    replicas: 1
    input: "raw_menu_items_batches"
    output:
      - name: "menu_items_source"
        routing_fn: "broadcast"

  stores:
    module: "store"
    replicas: 1
    input: "raw_stores_batches"
    output:
      - name: "stores_source"
        routing_fn: "broadcast"

  users:
    module: "user"
    replicas: 5
    input: "raw_users_batches"
    output:
      - name: "users_source"
        downstream_stage: "q4_enrich_users"
        downstream_workers: 5

  transactions:
    module: "transaction"
    replicas: 5
    input: "raw_transactions_batches"
    output:
      - name: "transactions_source"
        downstream_stage: "q1_filter_year"
        downstream_workers: 5

  transaction_items:
    module: "transaction_item"
    replicas: 5
    input: "raw_transaction_items_batches"
    output:
      - name: "transaction_items_source"
        downstream_stage: "q2_filter_items"
        downstream_workers: 5

queries:
  q1:
    description: "Filter transactions by year → hour → amount"
    enabled: true
    stages:
      filter_year:
        type: "filter"
        module: "year"
        replicas: 5
        input: "transactions_source"
        output:
          - name: "q1.filtered_year"
            downstream_stage: "q1_filter_hour"
            downstream_workers: 5
          - name: "q4.filtered_year"
            downstream_stage: "q4_aggregate_users"
            downstream_workers: 5
            routing_fn: "tx_router"

      filter_hour:
        type: "filter"
        module: "hour"
        replicas: 5
        input: "q1.filtered_year"
        output:
          - name: "q1.filtered_hour"
            downstream_stage: "q1_filter_amount"
            downstream_workers: 5
          - name: "q3.filtered_hour"
            downstream_stage: "q3_aggregate_semester"
            downstream_workers: 5

      filter_amount:
        type: "filter"
        module: "amount"
        replicas: 5
        input: "q1.filtered_hour"
        output:
          - name: "q1.filtered_amount"
            downstream_stage: "q1_sink"
            downstream_workers: 1

      sink:
        type: "sink"
        module: "sink_q1"
        replicas: 1
        input: "q1.filtered_amount"
        output:
          - name: "results"
            downstream_stage: "q1"
            downstream_workers: 1
            routing_fn: "by_stage_name"

  q2:
    description: "Filter items → aggregate by period → enrich with menu"
    enabled: true
    stages:
      filter_items:
        type: "filter"
        module: "item_year"
        replicas: 5
        input: "transaction_items_source"
        output:
          - name: "q2.filtered_items"
            downstream_stage: "q2_aggregate_period"
            downstream_workers: 5

      aggregate_period:
        type: "aggregator"
        module: "period_agg"
        replicas: 5
        input: "q2.filtered_items"
        output:
          - name: "q2.aggregated_period"
            downstream_stage: "q2_merge_period"
            downstream_workers: 1

      merge_period:
        type: "merger"
        module: "period_merge"
        replicas: 1
        input: "q2.aggregated_period"
        output:
          - name: "q2.merged_period"
            downstream_stage: "q2_enrich_items"
            downstream_workers: 1

      enrich_items:
        type: "enricher"
        module: "item_enricher"
        replicas: 1
        input: "q2.merged_period"
        enricher: "menu_items_source"
        output:
          - name: "q2.enriched_items"
            downstream_stage: "q2_sink"
            downstream_workers: 1

      sink:
        type: "sink"
        module: "sink_q2"
        replicas: 1
        input: "q2.enriched_items"
        output:
          - name: "results"
            downstream_stage: "q2"
            downstream_workers: 1
            routing_fn: "by_stage_name"

  q3:
    description: "Aggregate by semester/store → enrich with store data"
    enabled: true
    stages:
      aggregate_semester:
        type: "aggregator"
        module: "semester_agg"
        replicas: 5
        input: "q3.filtered_hour"
        output:
          - name: "q3.aggregated_semester"
            downstream_stage: "q3_merge_semester"
            downstream_workers: 1

      merge_semester:
        type: "merger"
        module: "semester_merge"
        replicas: 1
        input: "q3.aggregated_semester"
        output:
          - name: "q3.merged_semester"
            downstream_stage: "q3_enrich_stores"
            downstream_workers: 1

      enrich_stores:
        type: "enricher"
        module: "store_enricher"
        replicas: 1
        input: "q3.merged_semester"
        enricher: "stores_source"
        output:
          - name: "q3.enriched_stores"
            downstream_stage: "q3_sink"
            downstream_workers: 1

      sink:
        type: "sink"
        module: "sink_q3"
        replicas: 1
        input: "q3.enriched_stores"
        output:
          - name: "results"
            downstream_stage: "q3"
            downstream_workers: 1
            routing_fn: "by_stage_name"

  q4:
    description: "Route → aggregate by user → enrich → merge top-3 → enrich with store"
    enabled: true
    stages:
      aggregate_users:
        type: "aggregator"
        module: "user_purchase_aggregator"
        replicas: 5
        input: "q4.filtered_year"
        output:
          - name: "q4.aggregated_users"
            routing_fn: "broadcast"

      enrich_users:
        type: "enricher"
        module: "user_enricher"
        replicas: 5
        input: "users_source"
        enricher: "q4.aggregated_users"
        output:
          - name: "q4.enriched_users"
            downstream_stage: "q4_merge_top3"
            downstream_workers: 1

      merge_top3:
        type: "merger"
        module: "top_3"
        replicas: 1
        input: "q4.enriched_users"
        output:
          - name: "q4.merged_top3"
            downstream_stage: "q4_enrich_stores"
            downstream_workers: 1

      enrich_stores:
        type: "enricher"
        module: "store_enricher_q4"
        replicas: 1
        input: "q4.merged_top3"
        enricher: "stores_source"
        output:
          - name: "q4.enriched_stores"
            downstream_stage: "q4_sink"
            downstream_workers: 1

      sink:
        type: "sink"
        module: "sink_q4"
        replicas: 1
        input: "q4.enriched_stores"
        output:
          - name: "results"
            downstream_stage: "q4"
            downstream_workers: 1
            routing_fn: "by_stage_name"
